<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <nav class="top-nav">
    <div class="brand"><a href="/">Student Manager</a></div>
    <div class="nav-actions">
      <button id="add-new" class="button primary" type="button">+ New Student</button>
    </div>
  </nav>

  <main class="container">
    <section class="card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Dashboard</p>
          <h1>Students</h1>
        </div>
      </header>

      <div id="status" class="alert" hidden></div>

      <!-- Search and Filter Section -->
      <div class="search-filter-container">
        <div class="search-box-wrapper">
          <input 
            type="text" 
            id="global-search" 
            class="search-box" 
            placeholder="Search students by name, email, city..." 
          />
        </div>
        
        <div class="filters-toggle">
          <button id="filters-toggle-btn" class="button ghost icon-btn" type="button"><i class="fas fa-sliders-h"></i> Filters</button>
          <button id="generate-report-btn" class="button secondary" type="button"><i class="fas fa-file-chart-line"></i> Generate Report</button>
        </div>
      </div>

      <!-- Column Filters (Hidden by default) -->
      <div id="filters-panel" class="filters-panel" hidden>
        <div class="filters-grid">
          <div class="filter-item">
            <label for="filter-name">Name</label>
            <input type="text" id="filter-name" class="filter-input" placeholder="Filter by name...">
          </div>
          <div class="filter-item">
            <label for="filter-email">Email</label>
            <input type="text" id="filter-email" class="filter-input" placeholder="Filter by email...">
          </div>
          <div class="filter-item">
            <label for="filter-city">City</label>
            <input type="text" id="filter-city" class="filter-input" placeholder="Filter by city...">
          </div>
          <div class="filter-item">
            <label for="filter-state">State</label>
            <input type="text" id="filter-state" class="filter-input" placeholder="Filter by state...">
          </div>
          <div class="filter-item">
            <label for="filter-phone">Phone</label>
            <input type="text" id="filter-phone" class="filter-input" placeholder="Filter by phone...">
          </div>
        </div>
        <div class="filters-actions">
          <button id="clear-filters" class="button ghost" type="button">Clear All</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Photo</th>
              <th>Name</th>
              <th>Address</th>
              <th>City</th>
              <th>State</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Enrollment Date</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody id="students-body">
            <tr>
              <td colspan="9">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Overlay -->
  <div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <section class="card modal-card">
        <button id="close-modal" class="close-modal-btn">&times;</button>
        <header class="card-header">
          <div>
            <p class="eyebrow">Form</p>
            <h2 id="form-title">Add Student</h2>
          </div>
        </header>

        <form id="student-form" class="stacked-form" autocomplete="off">
          <input type="hidden" id="student-id" />
          
          <div class="form-section-left">
            <label>
              Name
              <input id="name" name="name" type="text" required />
            </label>
            <label>
              Address
              <input id="address" name="address" type="text" required />
            </label>
            <label>
              City
              <input id="city" name="city" type="text" required />
            </label>
            <label>
              State
              <input id="state" name="state" type="text" required />
            </label>
          </div>

          <div class="form-section-right">
            <label>
              Email
              <input id="email" name="email" type="email" required />
            </label>
            <label>
              Phone
              <input id="phone" name="phone" type="text" required />
            </label>
            <label>
              Enrollment Date
              <input id="enrollment_date" name="enrollment_date" type="date" required />
            </label>
            <div class="image-section">
              <label>
                Profile Image (Optional)
                <input id="profile_image" name="profile_image" type="file" accept="image/*" />
                <small>Max 5MB - JPEG, PNG, GIF, WebP</small>
                <div id="image-preview" class="image-preview-container"></div>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button id="cancel-edit" class="button ghost" type="button">Cancel</button>
            <button id="submit-btn" class="button primary" type="submit">Add Student</button>
          </div>
        </form>
      </section>
    </div>
  </div>


  <!-- Report Modal -->
  <div id="report-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <section class="card modal-card">
        <button id="close-report-modal" class="close-modal-btn">&times;</button>
        <header class="card-header">
          <div>
            <p class="eyebrow">Report</p>
            <h2>Monthly Enrollment Report</h2>
          </div>
        </header>

        <div id="report-status" class="alert" hidden></div>

        <div id="report-content" class="report-content">
          <p style="text-align: center; padding: 20px;">Loading report...</p>
        </div>

        <div class="form-actions">
          <button id="close-report-btn" class="button primary" type="button">Close</button>
          <button id="export-report-btn" class="button ghost" type="button"><i class="fas fa-download"></i> Export CSV</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const form = document.getElementById('student-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const addNewBtn = document.getElementById('add-new');
    const tableBody = document.getElementById('students-body');
    const studentIdInput = document.getElementById('student-id');
    const profileImageInput = document.getElementById('profile_image');
    const imagePreviewContainer = document.getElementById('image-preview');
    
    // Modal elements
    const modalOverlay = document.getElementById('modal-overlay');
    const closeModalBtn = document.getElementById('close-modal');
    
    // Report modal elements
    const reportModalOverlay = document.getElementById('report-modal-overlay');
    const closeReportModalBtn = document.getElementById('close-report-modal');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const reportContent = document.getElementById('report-content');
    const reportStatus = document.getElementById('report-status');
    const exportReportBtn = document.getElementById('export-report-btn');
    let reportData = []; // Store report data for export
    
    // Search and filter elements
    const globalSearchInput = document.getElementById('global-search');
    const filtersToggleBtn = document.getElementById('filters-toggle-btn');
    const filtersPanel = document.getElementById('filters-panel');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const filterInputs = document.querySelectorAll('.filter-input');

    const fields = ['name', 'address', 'city', 'state', 'email', 'phone', 'enrollment_date'];
    
    // Store all students for filtering
    let allStudents = [];

    const setStatus = (message, type = 'success') => {
      statusEl.textContent = message;
      statusEl.className = 'alert ' + (type === 'success' ? 'success' : 'danger');
      statusEl.hidden = false;
      setTimeout(() => {
        statusEl.hidden = true;
      }, 2600);
    };

    // Modal Logic
    const openModal = () => {
      modalOverlay.classList.add('open');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    };

    const closeModal = () => {
      modalOverlay.classList.remove('open');
      document.body.style.overflow = '';
      resetForm();
    };

    const resetForm = () => {
      form.reset();
      studentIdInput.value = '';
      formTitle.textContent = 'Add Student';
      submitBtn.textContent = 'Add Student';
      imagePreviewContainer.innerHTML = '';
    };

    // Profile image preview
    profileImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      imagePreviewContainer.innerHTML = '';
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.maxWidth = '150px';
          img.style.marginTop = '10px';
          img.style.borderRadius = '4px';
          imagePreviewContainer.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    const startEdit = (student) => {
      fields.forEach((key) => {
        document.getElementById(key).value = student[key] || '';
      });
      studentIdInput.value = student.id;
      formTitle.textContent = 'Edit Student';
      submitBtn.textContent = 'Update Student';
      
      // Show existing image if available
      imagePreviewContainer.innerHTML = '';
      if (student.profile_image) {
        const img = document.createElement('img');
        img.src = student.profile_image;
        img.style.maxWidth = '150px';
        img.style.marginTop = '10px';
        img.style.borderRadius = '4px';
        const label = document.createElement('p');
        label.textContent = 'Current image:';
        label.style.fontSize = '12px';
        label.style.marginTop = '10px';
        label.style.marginBottom = '5px';
        imagePreviewContainer.appendChild(label);
        imagePreviewContainer.appendChild(img);
      }
      
      openModal();
    };

    // Report Modal Logic
    const openReportModal = () => {
      reportModalOverlay.classList.add('open');
      document.body.style.overflow = 'hidden';
    };

    const closeReportModal = () => {
      reportModalOverlay.classList.remove('open');
      document.body.style.overflow = '';
      reportContent.innerHTML = '';
      reportData = [];
    };

    const setReportStatus = (message, type = 'success') => {
      reportStatus.textContent = message;
      reportStatus.className = 'alert ' + (type === 'success' ? 'success' : 'danger');
      reportStatus.hidden = false;
    };

    const renderReport = (data) => {
      if (!data || data.length === 0) {
        reportContent.innerHTML = '<p style="text-align: center; padding: 20px;">No enrollment data found for the last 30 days.</p>';
        return;
      }

      reportData = data; // Store for export
      const html = `
        <div style="overflow-x: auto;">
          <table class="data-table" style="width: 100%;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Enrollment Date</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(student => `
                <tr>
                  <td>${student.id}</td>
                  <td>${student.name}</td>
                  <td>${student.email}</td>
                  <td>${new Date(student.enrollment_date).toISOString().split('T')[0]}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px;">
          <p><strong>Total Enrollments (Last 30 Days):</strong> ${data.length}</p>
          <p><strong>Report Generated:</strong> ${new Date().toLocaleString()}</p>
        </div>
      `;
      reportContent.innerHTML = html;
    };

    const generateReport = async () => {
      try {
        openReportModal();
        reportContent.innerHTML = '<p style="text-align: center; padding: 20px;">Loading report...</p>';
        reportStatus.hidden = true;

        // Call the Lambda Function URL
        const lambdaUrl = 'https://g7hntzw3tn3qgd6oadrs37yjby0vsvmi.lambda-url.us-east-1.on.aws/';
        
        const response = await fetch(lambdaUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'success' && result.data) {
          renderReport(result.data);
          setReportStatus(`Report generated successfully. Found ${result.enrollmentCount} enrollments.`, 'success');
        } else {
          throw new Error(result.message || 'Failed to generate report');
        }
      } catch (error) {
        console.error('Error generating report:', error);
        reportContent.innerHTML = '<p style="text-align: center; padding: 20px; color: red;">Error generating report. Please try again.</p>';
        setReportStatus(error.message || 'Failed to generate report', 'danger');
      }
    };

    const exportReportAsCSV = () => {
      if (!reportData || reportData.length === 0) {
        alert('No data to export');
        return;
      }

      // Create CSV content
      const headers = ['ID', 'Name', 'Email', 'Enrollment Date'];
      const rows = reportData.map(student => [
        student.id,
        `"${student.name}"`,
        student.email,
        new Date(student.enrollment_date).toISOString().split('T')[0]
      ]);

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');

      // Create blob and download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `enrollment_report_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Filtering Logic
    const getFilterValues = () => {
      return {
        global: globalSearchInput.value.toLowerCase().trim(),
        name: document.getElementById('filter-name').value.toLowerCase().trim(),
        email: document.getElementById('filter-email').value.toLowerCase().trim(),
        city: document.getElementById('filter-city').value.toLowerCase().trim(),
        state: document.getElementById('filter-state').value.toLowerCase().trim(),
        phone: document.getElementById('filter-phone').value.toLowerCase().trim()
      };
    };

    const filterStudents = () => {
      const filters = getFilterValues();
      
      const filtered = allStudents.filter(student => {
        // Global search - searches across name, email, city
        if (filters.global) {
          const matchesGlobal = 
            student.name.toLowerCase().includes(filters.global) ||
            student.email.toLowerCase().includes(filters.global) ||
            student.city.toLowerCase().includes(filters.global) ||
            student.phone.toLowerCase().includes(filters.global);
          if (!matchesGlobal) return false;
        }

        // Column-specific filters
        if (filters.name && !student.name.toLowerCase().includes(filters.name)) return false;
        if (filters.email && !student.email.toLowerCase().includes(filters.email)) return false;
        if (filters.city && !student.city.toLowerCase().includes(filters.city)) return false;
        if (filters.state && !student.state.toLowerCase().includes(filters.state)) return false;
        if (filters.phone && !student.phone.toLowerCase().includes(filters.phone)) return false;

        return true;
      });

      renderStudents(filtered);
    };

    const renderStudents = (students) => {
      if (!students.length) {
        tableBody.innerHTML = '<tr><td colspan="10">No students found.</td></tr>';
        return;
      }

      tableBody.innerHTML = students
        .map(
          (s) => `
            <tr>
              <td>${s.id || 'None'}</td>
              <td>
                ${s.profile_image ? `<img src="${s.profile_image}" alt="${s.name}" class="table-thumbnail" title="View profile">` : '<span class="no-image">None</span>'}
              </td>
              <td>${s.name || 'None'}</td>
              <td>${s.address || 'None'}</td>
              <td>${s.city || 'None'}</td>
              <td>${s.state || 'None'}</td>
              <td>${s.email || 'None'}</td>
              <td>${s.phone || 'None'}</td>
              <td>${s.enrollment_date ? new Date(s.enrollment_date).toISOString().split('T')[0] : 'None'}</td>
              <td class="actions-col">
                <button class="icon-btn edit-btn" data-action="edit" data-id="${s.id}" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="icon-btn delete-btn" data-action="delete" data-id="${s.id}" title="Delete"><i class="fas fa-trash"></i></button>
                ${s.profile_image ? `<button class="icon-btn delete-img-btn" data-action="delete-image" data-id="${s.id}" title="Delete image"><i class="fas fa-image"></i></button>` : ''}
              </td>
            </tr>`
        )
        .join('');
    };

    const fetchStudents = async () => {
      try {
        const res = await fetch('/api/students');
        if (!res.ok) throw new Error('Failed to load students');
        const data = await res.json();
        allStudents = data;
        filterStudents();
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = '<tr><td colspan="10">Error loading students.</td></tr>';
        setStatus('Could not load students.', 'danger');
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData();
      fields.forEach((key) => {
        formData.append(key, document.getElementById(key).value.trim());
      });
      
      // Add profile image if selected
      const fileInput = document.getElementById('profile_image');
      if (fileInput.files.length > 0) {
        formData.append('profile_image', fileInput.files[0]);
      }
      
      const id = studentIdInput.value;
      const url = id ? '/api/students/' + id : '/api/students';
      const method = id ? 'PUT' : 'POST';

      try {
        const res = await fetch(url, {
          method,
          body: formData
          // Don't set Content-Type header - browser will set it with boundary
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');

        setStatus(id ? 'Student updated.' : 'Student added.');
        closeModal();
        fetchStudents();
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'Something went wrong.', 'danger');
      }
    });

    // Event Listeners
    addNewBtn.addEventListener('click', () => {
      resetForm();
      openModal();
    });

    cancelEditBtn.addEventListener('click', closeModal);
    closeModalBtn.addEventListener('click', closeModal);
    
    // Close modal when clicking outside
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        closeModal();
      }
    });

    // Report modal event listeners
    generateReportBtn.addEventListener('click', generateReport);
    closeReportModalBtn.addEventListener('click', closeReportModal);
    document.getElementById('close-report-btn').addEventListener('click', closeReportModal);
    exportReportBtn.addEventListener('click', exportReportAsCSV);

    // Close report modal when clicking outside
    reportModalOverlay.addEventListener('click', (e) => {
      if (e.target === reportModalOverlay) {
        closeReportModal();
      }
    });
    
    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (modalOverlay.classList.contains('open')) {
          closeModal();
        }
        if (reportModalOverlay.classList.contains('open')) {
          closeReportModal();
        }
      }
    });

    // Search and filter event listeners
    globalSearchInput.addEventListener('input', filterStudents);
    filterInputs.forEach(input => {
      input.addEventListener('input', filterStudents);
    });

    filtersToggleBtn.addEventListener('click', () => {
      const isHidden = filtersPanel.hidden;
      filtersPanel.hidden = !isHidden;
      filtersToggleBtn.classList.toggle('active', !isHidden);
    });

    clearFiltersBtn.addEventListener('click', () => {
      globalSearchInput.value = '';
      filterInputs.forEach(input => input.value = '');
      filterStudents();
    });

    tableBody.addEventListener('click', async (e) => {
      const button = e.target.closest('button[data-action]');
      if (!button) return;
      
      const action = button.dataset.action;
      const id = button.dataset.id;
      if (!action || !id) return;

      if (action === 'edit') {
        // Find existing data from allStudents array
        const student = allStudents.find(s => s.id == id);
        if (student) {
          startEdit(student);
        }
      }

      if (action === 'delete') {
        if (!confirm('Delete this student?')) return;
        try {
          const res = await fetch('/api/students/' + id, { method: 'DELETE' });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Delete failed');
          setStatus('Student deleted.');
          fetchStudents();
        } catch (err) {
          console.error(err);
          setStatus(err.message || 'Could not delete student.', 'danger');
        }
      }

      if (action === 'delete-image') {
        if (!confirm('Delete this profile image?')) return;
        try {
          const res = await fetch('/api/students/' + id + '/profile-image', { method: 'DELETE' });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Delete failed');
          setStatus('Image deleted.');
          fetchStudents();
        } catch (err) {
          console.error(err);
          setStatus(err.message || 'Could not delete image.', 'danger');
        }
      }
    });

    fetchStudents();
  </script>
</body>
</html>
