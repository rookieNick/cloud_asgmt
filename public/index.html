<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <nav class="top-nav">
    <div class="brand"><a href="/">Student Manager</a></div>
    <div class="nav-actions">
      <button id="add-new" class="button primary" type="button">+ New Student</button>
    </div>
  </nav>

  <main class="container">
    <section class="card">
      <header class="card-header">
        <div>
          <p class="eyebrow">Dashboard</p>
          <h1>Students</h1>
        </div>
      </header>

      <div id="status" class="alert" hidden></div>

      <!-- Search and Filter Section -->
      <div class="search-filter-container">
        <div class="search-box-wrapper">
          <input 
            type="text" 
            id="global-search" 
            class="search-box" 
            placeholder="Search students by name, email, city..." 
          />
        </div>
        
        <div class="filters-toggle">
          <button id="filters-toggle-btn" class="button ghost icon-btn" type="button"><i class="fas fa-sliders-h"></i> Filters</button>
        </div>
      </div>

      <!-- Column Filters (Hidden by default) -->
      <div id="filters-panel" class="filters-panel" hidden>
        <div class="filters-grid">
          <div class="filter-item">
            <label for="filter-name">Name</label>
            <input type="text" id="filter-name" class="filter-input" placeholder="Filter by name...">
          </div>
          <div class="filter-item">
            <label for="filter-email">Email</label>
            <input type="text" id="filter-email" class="filter-input" placeholder="Filter by email...">
          </div>
          <div class="filter-item">
            <label for="filter-city">City</label>
            <input type="text" id="filter-city" class="filter-input" placeholder="Filter by city...">
          </div>
          <div class="filter-item">
            <label for="filter-state">State</label>
            <input type="text" id="filter-state" class="filter-input" placeholder="Filter by state...">
          </div>
          <div class="filter-item">
            <label for="filter-phone">Phone</label>
            <input type="text" id="filter-phone" class="filter-input" placeholder="Filter by phone...">
          </div>
        </div>
        <div class="filters-actions">
          <button id="clear-filters" class="button ghost" type="button">Clear All</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Address</th>
              <th>City</th>
              <th>State</th>
              <th>Email</th>
              <th>Phone</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody id="students-body">
            <tr>
              <td colspan="8">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Overlay -->
  <div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <section class="card modal-card">
        <button id="close-modal" class="close-modal-btn">&times;</button>
        <header class="card-header">
          <div>
            <p class="eyebrow">Form</p>
            <h2 id="form-title">Add Student</h2>
          </div>
        </header>

        <form id="student-form" class="stacked-form" autocomplete="off">
          <input type="hidden" id="student-id" />
          <label>
            Name
            <input id="name" name="name" type="text" required />
          </label>
          <label>
            Address
            <input id="address" name="address" type="text" required />
          </label>
          <label>
            City
            <input id="city" name="city" type="text" required />
          </label>
          <label>
            State
            <input id="state" name="state" type="text" required />
          </label>
          <label>
            Email
            <input id="email" name="email" type="email" required />
          </label>
          <label>
            Phone
            <input id="phone" name="phone" type="text" required />
          </label>
          <div class="form-actions">
            <button id="cancel-edit" class="button ghost" type="button">Cancel</button>
            <button id="submit-btn" class="button primary" type="submit">Add Student</button>
          </div>
        </form>
      </section>
    </div>
  </div>



  <script>
    const statusEl = document.getElementById('status');
    const form = document.getElementById('student-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const addNewBtn = document.getElementById('add-new');
    const tableBody = document.getElementById('students-body');
    const studentIdInput = document.getElementById('student-id');
    
    // Modal elements
    const modalOverlay = document.getElementById('modal-overlay');
    const closeModalBtn = document.getElementById('close-modal');
    
    // Search and filter elements
    const globalSearchInput = document.getElementById('global-search');
    const filtersToggleBtn = document.getElementById('filters-toggle-btn');
    const filtersPanel = document.getElementById('filters-panel');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const filterInputs = document.querySelectorAll('.filter-input');

    const fields = ['name', 'address', 'city', 'state', 'email', 'phone'];
    
    // Store all students for filtering
    let allStudents = [];

    const setStatus = (message, type = 'success') => {
      statusEl.textContent = message;
      statusEl.className = 'alert ' + (type === 'success' ? 'success' : 'danger');
      statusEl.hidden = false;
      setTimeout(() => {
        statusEl.hidden = true;
      }, 2600);
    };

    // Modal Logic
    const openModal = () => {
      modalOverlay.classList.add('open');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    };

    const closeModal = () => {
      modalOverlay.classList.remove('open');
      document.body.style.overflow = '';
      resetForm();
    };

    const resetForm = () => {
      form.reset();
      studentIdInput.value = '';
      formTitle.textContent = 'Add Student';
      submitBtn.textContent = 'Add Student';
    };

    const startEdit = (student) => {
      fields.forEach((key) => {
        document.getElementById(key).value = student[key] || '';
      });
      studentIdInput.value = student.id;
      formTitle.textContent = 'Edit Student';
      submitBtn.textContent = 'Update Student';
      openModal();
    };

    // Filtering Logic
    const getFilterValues = () => {
      return {
        global: globalSearchInput.value.toLowerCase().trim(),
        name: document.getElementById('filter-name').value.toLowerCase().trim(),
        email: document.getElementById('filter-email').value.toLowerCase().trim(),
        city: document.getElementById('filter-city').value.toLowerCase().trim(),
        state: document.getElementById('filter-state').value.toLowerCase().trim(),
        phone: document.getElementById('filter-phone').value.toLowerCase().trim()
      };
    };

    const filterStudents = () => {
      const filters = getFilterValues();
      
      const filtered = allStudents.filter(student => {
        // Global search - searches across name, email, city
        if (filters.global) {
          const matchesGlobal = 
            student.name.toLowerCase().includes(filters.global) ||
            student.email.toLowerCase().includes(filters.global) ||
            student.city.toLowerCase().includes(filters.global) ||
            student.phone.toLowerCase().includes(filters.global);
          if (!matchesGlobal) return false;
        }

        // Column-specific filters
        if (filters.name && !student.name.toLowerCase().includes(filters.name)) return false;
        if (filters.email && !student.email.toLowerCase().includes(filters.email)) return false;
        if (filters.city && !student.city.toLowerCase().includes(filters.city)) return false;
        if (filters.state && !student.state.toLowerCase().includes(filters.state)) return false;
        if (filters.phone && !student.phone.toLowerCase().includes(filters.phone)) return false;

        return true;
      });

      renderStudents(filtered);
    };

    const renderStudents = (students) => {
      if (!students.length) {
        tableBody.innerHTML = '<tr><td colspan="8">No students found.</td></tr>';
        return;
      }

      tableBody.innerHTML = students
        .map(
          (s) => `
            <tr>
              <td>${s.id}</td>
              <td>${s.name}</td>
              <td>${s.address}</td>
              <td>${s.city}</td>
              <td>${s.state}</td>
              <td>${s.email}</td>
              <td>${s.phone}</td>
              <td class="actions-col">
                <button class="icon-btn edit-btn" data-action="edit" data-id="${s.id}" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="icon-btn delete-btn" data-action="delete" data-id="${s.id}" title="Delete"><i class="fas fa-trash"></i></button>
              </td>
            </tr>`
        )
        .join('');
    };

    const fetchStudents = async () => {
      try {
        const res = await fetch('/api/students');
        if (!res.ok) throw new Error('Failed to load students');
        const data = await res.json();
        allStudents = data;
        filterStudents();
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = '<tr><td colspan="8">Error loading students.</td></tr>';
        setStatus('Could not load students.', 'danger');
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(fields.map((key) => [key, document.getElementById(key).value.trim()]));
      const id = studentIdInput.value;
      const url = id ? '/api/students/' + id : '/api/students';
      const method = id ? 'PUT' : 'POST';

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');

        setStatus(id ? 'Student updated.' : 'Student added.');
        closeModal();
        fetchStudents();
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'Something went wrong.', 'danger');
      }
    });

    // Event Listeners
    addNewBtn.addEventListener('click', () => {
      resetForm();
      openModal();
    });

    cancelEditBtn.addEventListener('click', closeModal);
    closeModalBtn.addEventListener('click', closeModal);
    
    // Close modal when clicking outside
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        closeModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalOverlay.classList.contains('open')) {
        closeModal();
      }
    });

    // Search and filter event listeners
    globalSearchInput.addEventListener('input', filterStudents);
    filterInputs.forEach(input => {
      input.addEventListener('input', filterStudents);
    });

    filtersToggleBtn.addEventListener('click', () => {
      const isHidden = filtersPanel.hidden;
      filtersPanel.hidden = !isHidden;
      filtersToggleBtn.classList.toggle('active', !isHidden);
    });

    clearFiltersBtn.addEventListener('click', () => {
      globalSearchInput.value = '';
      filterInputs.forEach(input => input.value = '');
      filterStudents();
    });

    tableBody.addEventListener('click', async (e) => {
      const button = e.target.closest('button[data-action]');
      if (!button) return;
      
      const action = button.dataset.action;
      const id = button.dataset.id;
      if (!action || !id) return;

      if (action === 'edit') {
        // find existing data in table
        const row = e.target.closest('tr');
        const cells = row.querySelectorAll('td');
        const student = {
          id,
          name: cells[1].textContent,
          address: cells[2].textContent,
          city: cells[3].textContent,
          state: cells[4].textContent,
          email: cells[5].textContent,
          phone: cells[6].textContent
        };
        startEdit(student);
      }

      if (action === 'delete') {
        if (!confirm('Delete this student?')) return;
        try {
          const res = await fetch('/api/students/' + id, { method: 'DELETE' });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Delete failed');
          setStatus('Student deleted.');
          fetchStudents();
        } catch (err) {
          console.error(err);
          setStatus(err.message || 'Could not delete student.', 'danger');
        }
      }
    });

    fetchStudents();
  </script>
</body>
</html>
